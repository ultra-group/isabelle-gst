<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‚ÄπTools/locale_tools.ML‚Ä∫</title>
</head>


<body>
<div class="head">
<h1>File ‚ÄπTools/locale_tools.ML‚Ä∫</h1>
</div>

<pre class="source"><span class="comment1">(*Functions that allow interactions with Isar's locale interface.
  See src/Pure/Isar/
    locale.ML, expression.ML, element.ML, 
  See Isar Reference Manual - Sec 5.7 *)</span>

<span class="comment1">(*Each locale is identified with a ‚Äπstring‚Ä∫*)</span>

<span class="comment1">(*Gets full name of locale ‚Äπloc‚Ä∫ in ‚Äπthy‚Ä∫*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_locale</span> <span class="entity">thy</span> <span class="entity">loc</span> <span class="main">=</span> 
  <span class="entity">Locale.check</span> <span class="entity">thy</span> <span class="main">(</span><span class="entity">loc</span><span class="main">,</span> Position.none<span class="main">)</span>

<span class="comment1">(*Gets axioms of locale ‚Äπloc‚Ä∫ in ‚Äπthy‚Ä∫*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_locale_axioms</span> <span class="entity">thy</span> <span class="entity">loc</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> hd <span class="main">(</span><span class="entity">Locale.hyp_spec_of</span> <span class="entity">thy</span> <span class="entity">loc</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
     <span class="entity">Element.Assumes</span> <span class="entity">xs</span> <span class="main">=&gt;</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>fst <span class="entity">a</span><span class="main">,</span> fst <span class="main">(</span>hd <span class="entity">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span>
   <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> error <span class="main">(</span><span class="inner_quoted">"Couldn't get axioms of:"</span> ^ <span class="entity">loc</span><span class="main">)</span> 

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_locale_param_names</span> <span class="entity">thy</span> <span class="entity">loc</span> <span class="main">=</span>
  map <span class="main">(</span>Binding.name o fst o fst<span class="main">)</span> <span class="main">(</span><span class="entity">Locale.params_of</span> <span class="entity">thy</span> <span class="entity">loc</span><span class="main">)</span>

<span class="comment1">(*------ Locale Instances ------*)</span>

<span class="comment1">(*TODO: Write code for forming instances of classes *)</span>

<span class="comment1">(*A locale qualifier is a pair of type ‚Äπstring * bool‚Ä∫*)</span>
<span class="comment1">(*A parameter instantiation of ‚Äπloc‚Ä∫ is a pair ‚Äπ(iden, trm) : string * term‚Ä∫
  where ‚Äπiden‚Ä∫ is a parameter of ‚Äπloc‚Ä∫.*)</span>
<span class="comment1">(*A locale instance is formed from a triple ‚Äπ(loc, qual, params)‚Ä∫ where: 
    - ‚Äπloc‚Ä∫ is the name of a locale
    - ‚Äπqual‚Ä∫ is a locale qualifier
    - ‚Äπparams‚Ä∫ is a list of parameter instantiations of ‚Äπloc‚Ä∫ *)</span>
<span class="comment1">(* Let ‚Äπ(str,b)‚Ä∫ be a locale qualifer. 
  If ‚Äπb‚Ä∫ is true, then the qualifier ‚Äπstr‚Ä∫ must always be used in occurrences 
  of terms/facts defined in the locale when in a context of a locale declared with
  this locale instance as an import, or in the context enriched by an interpretation
  that uses this locale instance.
  Otherwise, the qualifier is optional.*)</span>

<span class="comment1">(*
  Function ‚Äπlocale_instance‚Ä∫ declared below creates a locale instance 
  from ‚Äπ(loc, paul, params)‚Ä∫. 
  Used in locale imports and interpretations.

  ---- EXAMPLE ---- 
  Let pair_inst = 
    ("Pair", ("Kuratowski", true), [("Pair", @{term iskpair}), ("pair", @{term kpair})]) 
  and nat_inst =
    ("Nat", ("vonNeumann", false), [("Nat", @{term isnat), ("Zero", @{term ‚àÖ}), (S, @{term Succ})])    
  
 1.1.  locale_instance pair_inst
  creates an ML term that is equivalent to that produced by the following Isar code
  which specifies a locale instance:
    Kuratowski : Pair 
      where Pair = iskpair 
        and pair = kpair 

 1.2. locale_instances [pair_inst, nat_inst]
    creates an ML term that is equivalent to that produced by the following Isar code
    which specifies a list of locale instances:
      Kuratowski : Pair 
      where Pair = iskpair 
        and pair = kpair
    + vonNeumann? : Nat
      where Nat = isnat
        and Zero = ‚àÖ
        and S = Succ
*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">locale_instance</span> <span class="main">(</span><span class="entity">loc</span><span class="main">,</span><span class="entity">qual</span><span class="main">,</span><span class="entity">params</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">loc</span><span class="main">,</span> <span class="main">(</span><span class="entity">qual</span><span class="main">,</span> <span class="main">(</span><span class="entity">Expression.Named</span> <span class="entity">params</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">locale_instances</span> <span class="entity">locs_params</span> <span class="main">=</span> map <span class="entity">locale_instance</span> <span class="entity">locs_params</span> <span class="main">:</span> <span class="main">(</span>string<span class="main">,</span> term<span class="main">)</span> <span class="entity">Expression.expr</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_for_clause</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">str</span><span class="main">,</span> <span class="entity">typ</span><span class="main">,</span> <span class="entity">syn</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>Binding.name <span class="entity">str</span><span class="main">,</span> SOME <span class="entity">typ</span><span class="main">,</span> <span class="entity">syn</span><span class="main">)</span><span class="main">)</span>
<span class="comment1">(*A parameter declaration is a triple of type ‚Äπstring * typ * mixfix‚Ä∫
  My terminology -- not Isabelle's. Corresponds with "the optional for clause"*)</span>
<span class="comment1">(*A list of lists of declarations is merged by a union operation, 
  where equality is determined by comparing the string of the declaration*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge_decls</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> 
  <span class="main">|</span> <span class="entity">merge_decls</span> <span class="main">(</span><span class="entity">xs</span>::<span class="entity">xss</span><span class="main">)</span> <span class="main">=</span> List.foldr <span class="main">(</span>merge <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">#</span><span class="inner_numeral">1</span> <span class="entity">p</span> <span class="main">=</span> <span class="main">#</span><span class="inner_numeral">1</span> <span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span> <span class="entity">xss</span>


<span class="comment1">(*When we import locales A and B (that each use a single type variable) 
  in the declaration of a locale C, we usually want the type variable used by the types of the 
  parameters of A to remain the same as the one one fixed by locale B. 
  By default, Isabelle uses a different type variable for A and B.
  
  We can use parameter declarations to ensure this type variable is the same.
  We can also use parameter declarations to change the type variable. 
  e.g., when defining Connection locales for model components*)</span>

<span class="comment1">(* A locale expression is a list of instances together with a list of parameter declarations.

  Creates a locale expression for the imports used in a locale declaration, 
  from a list of pairs ‚Äπ(loc, qual, decls)‚Ä∫ where ‚Äπloc‚Ä∫ is a locale name,
  ‚Äπqual‚Ä∫ is a locale qualifier, and ‚Äπdecls‚Ä∫ is a list of declarations.
  
 ---- EXAMPLE ----
  1.3. locale_import_expr [("Nat", ("foo",true), 
                            [("Nat", @{typ "'i ‚áí bool"}, nsyn), ("Zero", @{typ "'i"}, mk_sym "ùü¨"),
                             ("S", @{typ "'i ‚áí 'i", mk_sym "ùíÆ")]),
                           ("Pair", ("bar",false),
                             [("Pair", @{typ "'i ‚áí bool", nsyn), 
                              ("pair", @{typ "'i ‚áí 'i ‚áí bool", nsyn)])]
  creates an ML term denoting the locale import expression given by the Isar code

    foo  : Nat where Nat = Nat 
           and Zero = Zero
           and S = S
  + bar? : Pair where Pair = Pair
           and pair = pair
   for Nat :: "'i ‚áí bool"
   and Zero :: "'i" ("ùü¨")
   and S :: "'i ‚áí 'i" ("ùíÆ")
   and Pair :: "'i ‚áí bool"
   and pair :: "'i ‚áí 'i ‚áí bool"      *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">locale_import_expr</span> <span class="entity">locs_decls</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">free_params</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="entity">typ</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">str</span><span class="main">,</span> Free <span class="main">(</span><span class="entity">str</span><span class="main">,</span> <span class="entity">typ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">instances</span>   <span class="main">=</span> <span class="entity">locale_instances</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">loc</span><span class="main">,</span><span class="entity">qual</span><span class="main">,</span><span class="entity">decls</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">loc</span><span class="main">,</span><span class="entity">qual</span><span class="main">,</span><span class="entity">free_params</span> <span class="entity">decls</span><span class="main">)</span><span class="main">)</span> <span class="entity">locs_decls</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">all_decls</span>   <span class="main">=</span> <span class="entity">merge_decls</span> <span class="main">(</span>map <span class="main">(</span><span class="main">#</span><span class="inner_numeral">3</span><span class="main">)</span> <span class="entity">locs_decls</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">for_clause</span>  <span class="main">=</span> <span class="entity">mk_for_clause</span> <span class="entity">all_decls</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">instances</span><span class="main">,</span> <span class="entity">for_clause</span><span class="main">)</span> <span class="main">:</span> <span class="entity">Expression.expression_i</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*Creates a locale expression from a list of pairs of form ‚Äπ(loc, qual)‚Ä∫
  with declarations given by original declaration of ‚Äπloc‚Ä∫.*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">locale_expr_qual</span> <span class="entity">thy</span> <span class="entity">locs</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>  
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">decls</span> <span class="entity">loc</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="entity">typ</span><span class="main">)</span><span class="main">,</span><span class="entity">mix</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="entity">typ</span><span class="main">,</span><span class="entity">mix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Locale.params_of</span> <span class="entity">thy</span> <span class="entity">loc</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">locale_import_expr</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">loc</span><span class="main">,</span> <span class="entity">qual</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">loc</span><span class="main">,</span> <span class="entity">qual</span><span class="main">,</span> <span class="entity">decls</span> <span class="entity">loc</span><span class="main">)</span><span class="main">)</span> <span class="entity">locs</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*Creates a locale expression from a list of locales,
  using a default empty qualifier and declarations given by the original definition of the locale*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">locale_expr</span> <span class="entity">thy</span> <span class="main">=</span> <span class="entity">locale_expr_qual</span> <span class="entity">thy</span> o <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">loc</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">loc</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span>false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="comment1">(*Creates a locale expression used for interpretations 
  from a list of triples (‚Äπ(loc, qual, [(p1, t1), ..., (pn, tn)])‚Ä∫)
  Creates the same Isar code as Example 1.2, but as a "locale expression" rather than
  a "locale instance".*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">locale_expr_interp</span> <span class="entity">locs_terms</span> <span class="main">=</span> <span class="main">(</span><span class="entity">locale_instances</span> <span class="entity">locs_terms</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="entity">Expression.expression_i</span>



<span class="comment1">(*------ Locale Declarations ------*)</span>
<span class="comment1">(*Creates fix data from a triple of a string, type, and mixfix syntax*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_fix</span> <span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="entity">typ</span><span class="main">,</span><span class="entity">syn</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Binding.name <span class="entity">str</span><span class="main">,</span> <span class="entity">typ</span><span class="main">,</span> <span class="entity">syn</span><span class="main">)</span>
<span class="comment1">(*Creates assumption data from name and term for a locale expression *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_assm</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">trm</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Binding.name <span class="entity">name</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="entity">trm</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> 
<span class="comment1">(*Creates assumption data from name and a list of terms for a locale expression*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_assms</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">trms</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Binding.name <span class="entity">name</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="entity">trms</span><span class="main">)</span>

<span class="comment1">(*Returns term ‚Äπs : typ ‚â° trm‚Ä∫*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_def_ax</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">typ</span><span class="main">,</span> <span class="entity">trm</span><span class="main">)</span> <span class="main">=</span> Logic.mk_equals <span class="main">(</span>Free <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">typ</span><span class="main">)</span><span class="main">,</span> <span class="entity">trm</span><span class="main">)</span>
<span class="comment1">(*Creates assumption data with ‚Äπname_def‚Ä∫ and ‚Äπs : typ ‚â° trm‚Ä∫ for a locale expression*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_defines</span> <span class="main">(</span><span class="entity">def</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_assm</span> <span class="main">(</span><span class="entity">s</span> ^ <span class="inner_quoted">"_def"</span><span class="main">,</span> <span class="entity">mk_def_ax</span> <span class="entity">def</span><span class="main">)</span>

<span class="comment1">(*Takes a name, a list of locale expressions, a list of declarations, a list of assumptions,
  and a local theory, and returns a new local theory including locale given by declaration:
       ‚Äπlocale name = inst<span class="hidden">‚á©</span><sub>1</sub> + ... + inst<span class="hidden">‚á©</span><sub>n</sub> 
                   + fixes fix<span class="hidden">‚á©</span><sub>1</sub> and ... and fix<span class="hidden">‚á©</span><sub>n</sub>
                     assumes a<span class="hidden">‚á©</span><sub>1</sub> : œÜ<span class="hidden">‚á©</span><sub>1</sub> and ... and a<span class="hidden">‚á©</span><sub>n</sub> : œÜ<span class="hidden">‚á©</span><sub>n</sub>‚Ä∫   *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_locale</span> <span class="entity">name</span> <span class="entity">imports</span> <span class="entity">fixes</span> <span class="entity">assms</span> <span class="entity">lthy</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Local_Theory.exit_global <span class="entity">lthy</span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fixes'</span> <span class="main">=</span> <span class="entity">Element.Fixes</span> <span class="main">(</span>map <span class="entity">mk_fix</span> <span class="entity">fixes</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">assms'</span> <span class="main">=</span> <span class="entity">Element.Assumes</span> <span class="main">(</span>map <span class="entity">mk_assm</span> <span class="entity">assms</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">Expression.add_locale</span> <span class="main">(</span>Binding.name <span class="entity">name</span><span class="main">)</span> Binding.empty <span class="main">[</span><span class="main">]</span> <span class="entity">imports</span> <span class="main">[</span><span class="entity">fixes'</span><span class="main">,</span> <span class="entity">assms'</span><span class="main">]</span> <span class="entity">thy</span> <span class="keyword2"><span class="keyword">end</span></span> 


<span class="comment1">(*------ Modifying Locale Expressions ------*)</span>

<span class="comment1">(*Apply ‚Äπf : (string * term) list -&gt; (string * term) list‚Ä∫ to 
  the list of parameter instantiations in a locale instance*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">app_named_params</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">loc</span><span class="main">,</span> <span class="main">(</span><span class="entity">qual</span><span class="main">,</span> <span class="main">(</span><span class="entity">params</span><span class="main">,</span> <span class="entity">rw</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">params</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">Expression.Named</span> <span class="entity">ps</span> <span class="main">=&gt;</span> 
      <span class="main">(</span><span class="entity">loc</span><span class="main">,</span> <span class="main">(</span><span class="entity">qual</span><span class="main">,</span> <span class="main">(</span><span class="entity">Expression.Named</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">ps</span><span class="main">)</span><span class="main">,</span> <span class="entity">rw</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> error <span class="inner_quoted">"Not a locale instance with named parameters."</span>

<span class="comment1">(*Maps ‚Äπf : term -&gt; term‚Ä∫ over the terms of parameter instantiation of locale instance with named parameters*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_named_params</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">app_named_params</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="entity">trm</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">str</span><span class="main">,</span> <span class="entity">f</span> <span class="entity">trm</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="comment1">(*Extend the list of parameter instantiations of a locale instance*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">instantiate_params</span> <span class="entity">ps'</span> <span class="main">=</span> <span class="entity">app_named_params</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ps</span> <span class="main">=&gt;</span> <span class="entity">ps</span> @ <span class="entity">ps'</span><span class="main">)</span>

<span class="comment1">(*Applies ‚Äπf‚Ä∫ and ‚Äπg‚Ä∫ to the name and type of the declaration, if there is one.*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">decl_app</span> <span class="entity">f</span> <span class="entity">g</span> <span class="main">(</span><span class="entity">bd</span><span class="main">,</span> SOME <span class="entity">typ</span><span class="main">,</span> <span class="entity">syn</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">bd</span><span class="main">,</span> SOME <span class="main">(</span><span class="entity">g</span> <span class="entity">typ</span><span class="main">)</span><span class="main">,</span> <span class="entity">syn</span><span class="main">)</span> 
  <span class="main">|</span> <span class="entity">decl_app</span> <span class="entity">f</span> <span class="main">_</span> <span class="main">(</span><span class="entity">bd</span><span class="main">,</span> NONE<span class="main">,</span> <span class="entity">syn</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">bd</span><span class="main">,</span> NONE<span class="main">,</span> <span class="entity">syn</span><span class="main">)</span>

<span class="comment1">(*Maps ‚Äπf‚Ä∫ and ‚Äπg‚Ä∫ over a locale expression by: 
    - mapping ‚Äπf‚Ä∫ over the locale instances, and
    - applying ‚Äπg1‚Ä∫ and ‚Äπg2‚Ä∫ to each of the the fixed declarations‚Ä∫*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_expr'</span> <span class="entity">f</span> <span class="entity">g1</span> <span class="entity">g2</span> <span class="main">(</span><span class="entity">is</span><span class="main">,</span><span class="entity">ds</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="entity">map_named_params</span> <span class="entity">f</span><span class="main">)</span> <span class="entity">is</span><span class="main">,</span>  map <span class="main">(</span><span class="entity">decl_app</span> <span class="entity">g1</span> <span class="entity">g2</span><span class="main">)</span> <span class="entity">ds</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_expr</span> <span class="entity">f</span> <span class="entity">g</span> <span class="main">=</span> <span class="entity">map_expr'</span> <span class="entity">f</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span><span class="main">)</span> <span class="entity">g</span>


<span class="comment1">(*------ Using Interpretations of Locales ------*)</span>

<span class="comment1">(*Returns the morphism of most recent interpretation of ‚Äπloc‚Ä∫ in ‚Äπctxt‚Ä∫ *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">interp_morphism</span> <span class="entity">ctxt</span> <span class="entity">loc</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">Locale.registrations_of</span> <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">loc</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> error <span class="main">(</span><span class="inner_quoted">"No registration of locale "</span> ^ <span class="entity">loc</span> ^ <span class="inner_quoted">" found in context."</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">_</span>  <span class="main">=&gt;</span> snd <span class="main">(</span>hd <span class="main">(</span><span class="entity">Locale.registrations_of</span> <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">loc</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">interp_trm</span> <span class="entity">ctxt</span> <span class="entity">loc</span> <span class="main">=</span> Morphism.term <span class="main">(</span><span class="entity">interp_morphism</span> <span class="entity">ctxt</span> <span class="entity">loc</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">interp_typ</span> <span class="entity">ctxt</span> <span class="entity">loc</span> <span class="main">=</span> Morphism.typ <span class="main">(</span><span class="entity">interp_morphism</span> <span class="entity">ctxt</span> <span class="entity">loc</span><span class="main">)</span>

<span class="comment1">(*Creates a list of parameter instantiations from most recent interpretation of ‚Äπloc‚Ä∫*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">interp_params</span> <span class="entity">ctxt</span> <span class="entity">loc</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="entity">typ</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">str</span><span class="main">,</span> <span class="entity">interp_trm</span> <span class="entity">ctxt</span> <span class="entity">loc</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="entity">typ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                                  <span class="main">(</span><span class="entity">Locale.params_of</span> <span class="main">(</span><span class="entity">get_thy</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">loc</span><span class="main">)</span>

<span class="comment1">(*Create a locale instance of ‚Äπloc1‚Ä∫, with parameter instantiations given by 
  the most recent interpretation of ‚Äπloc2‚Ä∫*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">interp_instance</span> <span class="entity">ctxt</span> <span class="entity">loc1</span> <span class="entity">loc2</span> <span class="main">=</span> <span class="entity">locale_instance</span> <span class="main">(</span><span class="entity">loc1</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span>false<span class="main">)</span><span class="main">,</span> <span class="entity">interp_params</span> <span class="entity">ctxt</span> <span class="entity">loc2</span><span class="main">)</span> </pre>
</body>

</html>